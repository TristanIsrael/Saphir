# Contributor:
# Maintainer: Tristan IsraÃ«l <tristan.israel@icloud.com>
pkgname=saphir-container-eset
pkgver=2.0
pkgrel=1
pkgdesc="Saphir - LXC Container for ESET Antivirus"
url="https://defense.gouv.fr/"
arch="x86_64"
license="MIT"
depends="lxc"
makedepends="psec-container-debian"
checkdepends=""
install="$pkgname.post-install $pkgname.pre-deinstall"
subpackages=""
replaces=""
builddir="$srcdir/"
options="!check"  # no tests provided
source="https://download.eset.com/com/eset/apps/business/eea/linux/g2/latest/eeau_x86_64.bin"

clean() {
    sudo rm -rf "$srcdir" 
    sudo rm -rf "$pkgdir"
    sudo rm -rf "$builddir"
    sudo rm -rf /var/lib/lxc/"$pkgname"
}

build() {
    # We need to install ESET inside of the Debian container
    # That is done by adding network capabilities to the container
    # Then pushing ESET installer inside of the container
    # and finally run the installer

    # Rename the LXC container and reconfigure
    echo Copy the template container
    sudo rm -rf /var/lib/lxc/"$pkgname"
    sudo cp -r /var/lib/lxc/psec-container-debian /var/lib/lxc/"$pkgname"
    sudo chmod 770 /var/lib/lxc/"$pkgname"
    sudo chown -R admin /var/lib/lxc/"$pkgname"
    sed -i '/^lxc\.rootfs\.path/d' /var/lib/lxc/"$pkgname"/config
    sed -i '/^lxc\.uts\.name/d' /var/lib/lxc/"$pkgname"/config
    echo "" >> /var/lib/lxc/"$pkgname"/config
    echo "lxc.rootfs.path = dir:/var/lib/lxc/$pkgname/rootfs" >> /var/lib/lxc/"$pkgname"/config
    echo "lxc.uts.name = $pkgname" >> /var/lib/lxc/"$pkgname"/config

    # Extract the debian installer
    echo Extract ESET installer
    chmod +x "$srcdir"/eeau_x86_64.bin
    cd "$srcdir"
    ./eeau_x86_64.bin -n -y
    rm "$srcdir"/*.rpm
    rm "$srcdir"/eeau_x86_64.bin
    debfile=$(ls "$srcdir" | grep eea | grep .deb | head -n 1)

    # Extract the content of the debfile
    mkdir -p eset-deb
    ar x $debfile
    tar xzf control.tar.gz -C eset-deb
    tar xzf data.tar.gz -C eset-deb
    
    # Copy the post install script into the container
    echo Copy post install script into the container
    sudo cp eset-deb/postinst /var/lib/lxc/"$pkgname"/rootfs/root

    # Copy ESET files into the container
    echo Copy ESET files into the container
    sudo cp -r eset-deb/opt/* /var/lib/lxc/"$pkgname"/rootfs/opt
    sudo cp -r eset-deb/var/* /var/lib/lxc/"$pkgname"/rootfs/var
    sudo cp -r eset-deb/usr/* /var/lib/lxc/"$pkgname"/rootfs/usr

    # Setup the network
    echo Start networking
    sed -i '/^#lxc\.net/s/^#//' "/var/lib/lxc/$pkgname/config"
    sudo service dnsmasq.lxcbr0 start

    # Start the container and install ESET
    echo Start LXC container
    sudo rc-service cgroups start
    sudo lxc-start -n "$pkgname"    

    sleep 1

    echo *** Update APT
    sudo lxc-attach -n "$pkgname" -- apt update

    echo Install libcurl
    sudo lxc-attach -n "$pkgname" -- apt install -y libcurl4    

    echo Execute ESET post install script
    sudo lxc-attach -n "$pkgname" -- env ESET_DISABLE_WAP=1 /root/postinst configure

    echo Clean the container to make it smaller
    sudo rm -rf /var/lib/lxc/"$pkgname"/rootfs/var/opt/eset/eea/updated
    sudo rm -rf /var/lib/lxc/"$pkgname"/rootfs/var/opt/eset/eea/lib/*.tar
    sudo rm -rf /var/lib/lxc/"$pkgname"/rootfs/usr/share/doc
    sudo rm -rf /var/lib/lxc/"$pkgname"/rootfs/usr/share/man
    sudo rm -rf /var/lib/lxc/"$pkgname"/rootfs/usr/share/mime
    sudo rm -rf /var/lib/lxc/"$pkgname"/rootfs/usr/share/info
    sudo rm -rf /var/lib/lxc/"$pkgname"/rootfs/usr/share/vim
    sudo rm -rf /var/lib/lxc/"$pkgname"/rootfs/usr/share/i18n
    sudo rm -rf /var/lib/lxc/"$pkgname"/rootfs/usr/share/locale
    sudo rm -rf /var/lib/lxc/"$pkgname"/rootfs/var/lib/apt/lists
    sudo lxc-attach -n "$pkgname" -- apt-get clean

    # Stop the container
    echo Stop the container
    sudo lxc-stop -n "$pkgname"    

    # Disable networking
    echo Disable netorking
    sed -i 's/^lxc\.net/#&/' /var/lib/lxc/"$pkgname"/config

    # Add PSEC mount points
    echo Add mount points
    echo "" >> /var/lib/lxc/"$pkgname"/config
    echo "lxc.mount.entry = /mnt/storage mnt/storage none bind,optional,create=dir" >> /var/lib/lxc/"$pkgname"/config

    # Add XEN pv channels
    echo Add XEN PV channels
    echo "" >> /var/lib/lxc/"$pkgname"/config
    echo "lxc.mount.entry = /dev/hvc1 dev/hvc1 none bind,optional,create=file" >> /var/lib/lxc/"$pkgname"/config

    # Change the rootfs path
    sed -i '/^lxc\.rootfs\.path/d' /var/lib/lxc/"$pkgname"/config
    echo "lxc.rootfs.path = dir:/mnt/merged" >> /var/lib/lxc/"$pkgname"/config
}

package() {
    # The new package will be based on the vanilla psec-container-debian
    # which won't be useful anymore. We will package the whole container
    # including ESET installation
    mkdir -p "$pkgdir"/var/lib/saphir

    # Since 2.0 We use Squashfs to make it smaller and quicker
    # Tar container
    # sudo tar cf "$pkgdir"/var/lib/lxc/"$pkgname".tar -C /var/lib/lxc/ .
    # sudo chown $USER "$pkgdir"/var/lib/lxc/"$pkgname".tar
    # Compress archive
    # bzip2 "$pkgdir"/var/lib/lxc/"$pkgname".tar    

    cd /var/lib/lxc/"$pkgname"    
    sudo mksquashfs rootfs "$pkgdir"/var/lib/saphir/"$pkgname".sqfs -comp xz -b 1M -Xdict-size 100%
}
