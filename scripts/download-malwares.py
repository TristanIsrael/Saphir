import requests
import random
import argparse
import sys
from malware_bazaar import Bazaar

API_KEY = "cd41a2ca9ef2928bcc5a9292db9a402a50e8ad6189da6e70"

def print_warning():
    warning_text = """
    ****************************************************************************************
    * WARNING: THIS SCRIPT DOWNLOADS POTENTIALLY MALICIOUS FILES FROM MALWARE BAZAAR.       *
    *                                                                                      *
    * USING THESE FILES POSES SERIOUS SECURITY RISKS.                                      *
    * YOU MUST RUN THIS SCRIPT ONLY IN A SECURE, ISOLATED VIRTUAL MACHINE OR SANDBOX ENV.  *
    * DO NOT RUN THIS ON YOUR MAIN SYSTEM TO AVOID IRREVERSIBLE DAMAGE OR DATA LOSS.        *
    *                                                                                      *
    * YOU ARE SOLELY RESPONSIBLE FOR ANY DAMAGE CAUSED BY USING THIS SCRIPT.                *
    ****************************************************************************************
    """
    print(warning_text, file=sys.stderr)

def get_random_malware(dry_run=False):
    b = Bazaar(api_key=API_KEY)
    j = b.bazaar_list_samples(selector='100')

    if "data" not in j:
        print("No data received")
        return
    
    hashes = []
    data = j["data"]
    for entry in data:
        if "sha256_hash" in entry:
            hashes.append(entry["sha256_hash"])
    
    if dry_run:
        print(f"[DRY-RUN] Would download {len(hashes)} malware samples")
    else:
        for h in hashes:
            print(f"Download malware with hash {h}")
            b.bazaar_download(hash=h, unzip=False)

if __name__ == "__main__":
    print_warning()
    parser = argparse.ArgumentParser(description="Download random malware sample from Malware Bazaar")
    parser.add_argument('--dry-run', action='store_true', help="Do not download, just simulate")
    args = parser.parse_args()
    
    get_random_malware(dry_run=args.dry_run)